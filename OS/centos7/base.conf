include OS/${DISTRO}/distro_urls.conf

osinst_last: osinst_clean
		touch osinst_last

osinst_base: ramdisk_build_1
	# base
	mkdir -p ${TARGET}/etc/yum.repos.d/
	cp -fv OS/${DISTRO}/nyble-CentOS7.repo ${TARGET}/etc/yum.repos.d/
	yum install -y basesystem --releasever=7 --nogpgcheck --installroot=${TARGET}
	#echo "exclude=*.i?86" >> ${TARGET}/etc/yum.conf
	cp OS/${DISTRO}/dracut-functions.sh ${TARGET}/usr/lib/dracut/dracut-functions.sh
	touch osinst_base

osinst_repos:	osinst_base
	cd ${TARGET}/root ; wget ${CENTOS_KEY1} ${CENTOS_KEY2} ; rpm --import 	\
		--root=${TARGET} RPM-GPG-KEY-CentOS-7 ; rpm --import --root=${TARGET} \
		RPM-GPG-KEY-CentOS-Testing-7 ; rm -f RPM-GPG*
	
	touch osinst_repos

osinst_min: osinst_repos
	#yum groups -y install "Minimal Install" "Virtualization" --releasever=7 	 \
	#	--installroot=${TARGET}
	yum -y install bash coreutils cronie curl dhclient e2fsprogs   \
		filesystem glibc hostname initscripts iproute iprutils \
		iptables iputils irqbalance kbd kexec-tools less       \
		man-db ncurses openssh-clients openssh-server parted   \
		passwd plymouth policycoreutils procps-ng rootfiles    \
		rpm rsyslog setup shadow-utils sudo systemd tar        \
		util-linux vim xfsprogs yum biosdevname                \
		dracut-config-rescue kernel-tools libsysfs             \
		linux-firmware microcode_ctl gdb kexec-tools latrace   \
		libreport-cli strace systemtap-runtime abrt-cli	       \
		crash crash-gcore-command crash-ptdump-command         \
		crash-trace-command elfutils kernel-tools ltrace       \
		memstomp ps_mem trace-cmd cmake git edac-utils         \
		rasdaemon mcelog smartmontools intel-cmt-cat tmux      \
		--installroot=${TARGET}
	touch osinst_min


osinst_dev: osinst_min
	yum groups -y install "Development Tools" "Virtualization"     \
		"System Administration Tools" "System Management"      \
		--releasever=7 --installroot=${TARGET}
	touch osinst_dev

osinst_epel: osinst_dev
	rpm -Uvh \
	 http://mirrors.syringanetworks.net/fedora-epel/7/x86_64/Packages/e/epel-release-7-11.noarch.rpm \
	  --root ${TARGET}
	touch osinst_epel

osinst_func: osinst_epel
	yum -y install lsof lsscsi lslk psmisc glibc-headers cifs-utils  \
		anaconda-dracut anaconda  --releasever=7 --installroot=${TARGET}
	yum -y groupinstall "Console Internet Tools"  \
		--installroot=${TARGET}
	touch osinst_func

osinst_net: osinst_func
	#
	# disable network manager ... seriously ... it is beyond broken
	yum -y install net-tools --installroot=${TARGET}
	chroot ${TARGET} systemctl disable NetworkManager.service
	sed -i 's|^NM_CONTROLLED=.*|NM_CONTROLLED=no|g'	\
	 	${TARGET}/etc/sysconfig/network-scripts/ifcfg-*
	chroot ${TARGET} chkconfig --add network
	chroot ${TARGET} chkconfig network on
	#
	# enable all network ports on boot
	sed -i 's|^ONBOOT=.*|ONBOOT=yes|g' \
		${TARGET}/etc/sysconfig/network-scripts/ifcfg-*
	touch osinst_net


osinst_dev2: osinst_net
	yum -y install OpenIPMI ipmitool edac-utils --installroot=${TARGET}
	touch osinst_dev2

osinst_utils: osinst_dev2
	touch ${TARGET}/etc/mdadm.conf
	#
	# parallel gzip and bzip2
	#
	yum -y install bzip2 xz pxz pbzip2 pigz which --installroot=${TARGET}
	mv ${TARGET}/usr/bin/gzip ${TARGET}/usr/bin/gzip.original
	chroot ${TARGET} ln -s /usr/bin/pigz /usr/bin/gzip
	mv ${TARGET}/usr/bin/bzip2 ${TARGET}/usr/bin/bzip2.original
	chroot ${TARGET} ln -s /usr/bin/pbzip2 /usr/bin/bzip2
	mv ${TARGET}/usr/bin/xz ${TARGET}/usr/bin/xz.original
	chroot ${TARGET} ln -s /usr/bin/pxz /usr/bin/xz

	# useful for utils
	yum -y install perl-ExtUtils-MakeMaker.noarch blkid strace        \
			libblkid-devel wget install iptraf ifstat	 \
			dstat htop perl-CPAN perl-JSON-PP perl-MCE       \
			perl-MCE-Shared perl-MCE-tools perl-IPC-Run      \
			OpenIPMI OpenIPMI-libs ipmitool glances          \
			 --installroot=${TARGET}

	touch osinst_utils


osinst_task: osinst_utils

	touch osinst_task


osinst_hvm: osinst_task
ifeq ($(HVM),1)
	# kvm

endif
	touch osinst_hvm



osinst_bind: osinst_hvm
	mount --bind /dev  ${TARGET}/dev/
	mount --bind /proc ${TARGET}/proc/
	mount --bind /sys  ${TARGET}/sys/
	yum -y install acpid acpid-sysvinit acpica-tools rpcbind portmap \
		 --installroot=${TARGET}
	touch osinst_bind

osinst_grub: osinst_bind
ifdef PHYSICAL
	yum -y install grub2 grub2-tools  grub-customizer --installroot=${TARGET}
	#chroot ${TARGET} apt-get -y install grub-pc
	mkdir -p ${TARGET}/etc/default
	cp grub.conf ${TARGET}/etc/default/grub
	cp -r ${TARGET}/usr/lib/grub/i386-pc ${TARGET}/boot/grub
	cp -r ${TARGET}/usr/lib/grub/i386-pc ${TARGET}/boot/grub2
endif
	touch osinst_grub

osinst_off:	osinst_grub

	touch osinst_off

osinst_clean: osinst_modern_dev

ifeq ($(ONLYCORE),1)

endif
	yum -y remove postfix iwl* NetworkManager* ModemManager* \
	  	alsa* aic94xx* avahi* btrfs* cairo* cdparanoia*  \
		colord* ivtv* libX* mesa* mariadb*               \
		nm-connection-editor yelp* wpa_supplicant        \
		gnome-icon-theme            \
		gsettings-desktop-schemas gstreamer1             \
		hicolor-icon-theme libogg* libtiff libwebp       \
		lyx-fonts    \
		--installroot=${TARGET}
	touch osinst_clean

osinst_modern_dev: osinst_off
	#yum -y install centos-release-scl devtoolset-7-gcc-c++
	# to use gcc-7 do "scl enable devtoolset-7 bash" at command line.
	touch osinst_modern_dev
